<!--Definição de HTML, obrigatório inclusão-->
<!DOCTYPE html>
<html lang="pt-br">
<!--Definição de HTML, obrigatório inclusão-->
<!----->
<!--<head> Refere-se a metadados, ou seja, dados sobre dados. São esses dados que são retornados ao se buscar em motores/intranets-->

<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <title>Equipamentos Fábrica 01</title>
    <!--Carrega Dados de estilização (CSS e UX para o documento. Bootstrap é uma biblioteca famosa com funções úteis, já stylesheet é a padronização do equipamento)-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/General_stylesheet.css">
    <!--Recomendação de fonte da net-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!--Carrega Dados de estilização (CSS e UX para o documento. Bootstrap é uma biblioteca famosa com funções úteis, já stylesheet é a padronização do equipamento)-->
    <style>
        area,
        area:focus {
            outline: none;
        }
    </style>

</head>
<!--Cor da grendene: style: "background-color:rgba(100, 154, 210, 1)"-->

<body style="background-color:rgba(100, 154, 210, 1)">
    <div id="navbar-container"></div>
    <!-- Primeira luz verde -->
    <!-- #region Mapa1 -->
    <div class="image-container">
        <img src="images/Imagem_final_01.gif" alt="Fact_01" class="centered-image" usemap="#image-map">
        <map name="image-map">
            <!--ÍNICIO ARES COMPRIMIDOS-->
            <area target="_self" alt="Ar_comprimido_Baixa_Pressão_S1-comp-002" title="S1-COMP-002"
                data-name="S1-COMP-002" href="#" coords="38,475,170,628" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Nirvana SSR - EP100" data-class="B" data-brand="Nirvana SSR-EP100">
            <area target="_self" alt="Ar_comprimido_Baixa_Pressão_S1-comp-001" title="S1-COMP-001"
                data-name="S1-COMP-001" href="#" coords="185,477,350,627" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Ingersoll R75N-A" data-class="B" data-brand="Ingersoll R75N-A">
            <area target="_self" alt="Ar_comprimido_Baixa_Pressão_S1-comp-003" title="S1-COMP-003"
                data-name="S1-COMP-003" href="#" coords="369,475,498,626" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Ingersoll EP100 A/C" data-class="B"
                data-brand="Ingersoll EP100 A/C">
            <area target="_self" alt="Ar_comprimido_Baixa_Pressão_S1-comp-004" title="S1-COMP-004"
                data-name="S1-COMP-004" href="#" coords="536,476,665,627" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Ingersoll EP100 A/C" data-class="B"
                data-brand="Ingersoll EP100 A/C">
            <!--FIM DOS ARES COMPRIMIDOS-->
            <!--ÍNICIO TORRES DE AZOTO E VASOS DE PRESSÃO-->
            <area target="_self" alt="Vaso_de_Pressão_S1_Vasp_009" title="S1-VASP-009" href="#" data-name="S1-VASP-009"
                coords="603,112,56" shape="circle" data-toggle="modal" data-target="#popupModal"
                data-tag="Engentank A15.595" data-class="C" data-brand="Engetank">
            <area target="_self" alt="Vaso_de_Pressão_S1_Vasp_010" title="S1-VASP-010" href="#" data-name="S1-VASP-010"
                coords="600,238,57" shape="circle" data-toggle="modal" data-target="#popupModal"
                data-tag="Engentank A15.594" data-class="C" data-brand="Engetank">
            <area target="_self" alt="Nitrogen_generator_s1_Gern_001" title="S1-GERN-001" href="#"
                data-name="S1-GERN-001"
                coords="719,64,793,290" shape="rect"
                data-toggle="modal" data-target="#popupModal" data-tag="Psa-Technology QQ7F15TG" data-class="C"
                data-brand="PSA-Technology">
            <area target="_self" alt="Nitrogen_Generator_s1_Gern_002" title="S1-GERN-002" href="#"
                data-name="S1-GERN-002" coords="835,73,904,72,894,283,843,280" shape="poly" data-toggle="modal"
                data-target="#popupModal" data-tag="Psa-Technology QQ7F15TG" data-class="C">
            <area target="_self" alt="S1_Filtro_005" title="S1-FILC-005" href="#" coords="983,95,1044,224"
                data-brand="Parker" data-name="S1-FILC-005" shape="rect" data-toggle="modal" data-target="#popupModal"
                data-tag="Parker AOP045IGFX" data-class="B">
            <area target="_self" alt="Vaso_de_Pressão_S1_Vasp_001" title="S1-VASP-001" href="#" data-name="S1-VASP-001"
                coords="1159,134,65" shape="circle" data-toggle="modal" data-target="#popupModal"
                data-tag="Engentank A15.595" data-class="C" data-brand="Engetank">
            <!--FIM TORRES DE AZOTO E VASOS DE PRESSÃO-->
            <!--ÍNICIO ARES COMPRIMIDOS SUPLEMENTARES-->
            <area target="_self" alt="Industrial_Air_Dryer_S1_seca_001" title="S1-SECA-001" data-name="S1-SECA-001"
                href="#" coords="838,383,934,567" shape="rect" data-toggle="modal" data-target="#popupModal"
                data-tag="Parker DRD2000 - A46036014EI" data-class="A" data-brand="Parker">
            <area target="_self" alt="Coalescent_Filter_S1_Filc_001" title="S1-FILC-001" href="#"
                data-name="S1-FILC-001" coords="970,389,1040,533" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Parker OIL-X Evolution AO060KGFFX" data-class="B"
                data-brand="Parker">
            <area target="_self" alt="Industrial_Air_Dryer_S1_seca_002" title="S1-SECA-002" data-name="S1-SECA-002"
                href="#" coords="1075,464,1162,633" shape="rect" data-toggle="modal" data-target="#popupModal"
                data-tag="Ingersoll Rand TD 570" data-class="B" data-brand="Ingersoll">
            <area target="_self" alt="Coalescent_Filter_S1_Filc_002" title="S1-FILC-002" href="#"
                data-name="S1-FILC-002" coords="1207,531,1269,661" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Parker AOP045IGFX" data-class="B" data-brand="Parker">
            <area target="_self" alt="Coalescent_Filter_S1_Filc_003" title="S1-FILC-003" href="#"
                data-name="S1-FILC-003" coords="1208,388,1270,520" shape="rect" data-toggle="modal"
                data-target="#popupModal" data-tag="Parker AOP045IGFX" data-class="B" data-brand="Parker">
            <!--FIM ARES COMPRIMIDOS SUPLEMENTARES-->
        </map>
        <!--<button class="btn btn-primary login-btn" id="narrativa">
            <i class="fas fa-sign-in-alt"></i> Descritiva
        </button>-->
        <!--<a href="/Complete_Test/defeitos.txt" download="defeitos.txt">
            <button class="btn btn-primary">Baixar Defeitos</button>
        </a>-->
        <div id="lights-container"></div>
        <div id="notification"
            style="display: none; background-color: #4CAF50; color: white; padding: 10px; text-align: center; position: fixed; top: 0; width: 100%;">
            Planilha atualizada! Recarregue a página para ver as mudanças.
        </div>
    </div>
    <!--#endregion-->
    <!-- #region Popup -->
    <div id="popupModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <span>Name:</span>
                                        <img src="images/download_icon.png" 
                                            alt="Download Icon" class="input-icon download-icon" id="downloadIcon" width="30" height="40" style="margin-left: 225px;"
                                            data-toggle="tooltip_download" title="Clique aqui para fazer o download">
                                        <img src="https://cdn.icon-icons.com/icons2/2446/PNG/512/edit_text_icon_148716.png"
                                            alt="Edit Icon" class="input-icon" id="editIcon" width="30" height="30"
                                            data-toggle="tooltip_eqpto" title="Clique aqui para comentar o defeito do equipamento">
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mt-2">
                                            <span><strong>Classe de reparo:</strong></span>
                                            <span></span> <!-- Atualizado via JavaScript -->
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <span><strong>Modelo:</strong></span>
                                            <span style="color:#dc3545"></span> <!-- Atualizado via JavaScript -->
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <span><strong>Última Vistoria:</strong></span>
                                            <span>(Vai_pegar_do_banco)</span> <!-- Atualizado via Base_dados -->
                                        </div>
                                        <div id="text-box" style="display: none;">
                                            <textarea id="defectInput" placeholder="Descreva o defeito aqui"></textarea>
                                            <button id="saveDefect">Salvar</button>
                                            <button id="statusButton">Status</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--#endregion-->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/General_Factory_control.js"></script>
    <script>
        function adjustMapAreas() {
            var img = document.querySelector('img');
            var areas = document.querySelectorAll('map area');
            var imgWidth = img.offsetWidth;

            areas.forEach(area => {
                var coords = area.getAttribute('coords').split(',');
                var adjustedCoords = coords.map(coord => Math.round(coord * (imgWidth / img.naturalWidth)));
                area.setAttribute('coords', adjustedCoords.join(','));
            });
        }

        window.addEventListener('resize', adjustMapAreas);
        window.addEventListener('load', adjustMapAreas);
    </script>
    <!--<script src="/socket.io/socket.io.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Função para calcular o centro de um polígono baseado nas coordenadas
        function getPolygonCenter(coords) {
            let x = 0, y = 0, n = coords.length / 2;
            for (let i = 0; i < coords.length; i += 2) {
                x += parseInt(coords[i]);
                y += parseInt(coords[i + 1]);
            }
            return { x: Math.round(x / n), y: Math.round(y / n) };
        }
    
        // Função para calcular o espaçamento horizontal
        function calculateHorizontalSpacing() {
            const image = document.querySelector('.centered-image');
            const imageWidth = image.getBoundingClientRect().width;
            const viewportWidth = window.innerWidth;
            return (viewportWidth - imageWidth) / 2;
        }
    
        // Função para obter as coordenadas centralizadas e ajustadas
        function getEquipmentPositions() {
            const positions = [];
            const dataNames = [
                "S1-COMP-001", "S1-COMP-002", "S1-COMP-003", "S1-COMP-004",
                "S1-SECA-001", "S1-SECA-002", "S1-GERN-001", "S1-GERN-002"
            ];
            
            const a = calculateHorizontalSpacing();
            const navbar = document.getElementById('sidebar');
            const navbarHeight = navbar.getBoundingClientRect().height;
    
            dataNames.forEach(dataName => {
                const area = document.querySelector(`area[data-name="${dataName}"]`);
                if (area) {
                    const coords = area.getAttribute('coords').split(',').map(Number);
                    const center = getPolygonCenter(coords);
    
                    // Ajuste as coordenadas com a navbar e o espaçamento horizontal
                    const top = `${center.y + navbarHeight}px`;
                    const left = `${center.x + a - 15}px` ;
    
                    // Armazene a posição ajustada
                    positions.push({ top, left });
                    console.log(`Posição de ${dataName}: top=${top}, left=${left}`);
                }
            });
    
            return positions;
        }
    
        // Função para posicionar as luzes com base nas coordenadas calculadas
        function positionLights(lightsData) {
            const imageContainer = document.querySelector('.image-container');
            const positions = getEquipmentPositions();
    
            lightsData.forEach((luz, index) => {
                const lightDiv = document.createElement('div');
                lightDiv.className = `light ${luz.cor}`;
    
                // Utilize as posições armazenadas no array `positions`
                if (positions[index]) {
                    lightDiv.style.top = positions[index].top;
                    lightDiv.style.left = positions[index].left;
                    imageContainer.appendChild(lightDiv);
                }
            });
        }
    
        document.addEventListener('DOMContentLoaded', function () {
            try {
                fetch('/lights')
                    .then(response => response.json())
                    .then(lightsData => {
                        positionLights(lightsData);
                    });
            }
            catch (error) {
                console.error('Erro ao manipular as luzes:', error);
            }
        });
    
        // Reposiciona as luzes ao redimensionar a janela
        window.addEventListener('resize', () => {
            fetch('/lights')
                .then(response => response.json())
                .then(lightsData => {
                    document.querySelectorAll('.light').forEach(light => light.remove()); // Limpa as luzes atuais
                    positionLights(lightsData); // Reposiciona as luzes
                });
        });
    </script>
    
    <!--
    <script>
        var socket = io();

        // Ouvir o evento 'planilhaAtualizada' do servidor
        socket.on('planilhaAtualizada', function () {
            // Mostrar uma notificação ao usuário
            var notification = document.getElementById('notification');
            notification.style.display = 'block';
        });
    </script>
    -->
    
</body>